# Supernoba Candle System - Technical Handover Report

**Target Audience:** Advanced AI Assistant (Claude Opus 4.5 level)
**Date:** 2025-12-17
**Topic:** Real-time Chart Data Consistency & System Architecture

---

## 1. System Architecture Overview

The Supernoba Candle System processes high-frequency trading data into candlestick charts (OHLCV).

### Data Flow Pipeline
1.  **Matching Engine (C++ `wrapper`)**:
    *   Generates "fills" (trades).
    *   Updates 1-minute candle data in **Redis (Valkey)** via Lua Script.
    *   **CRITICAL PROTOCOL**: The `t` (time) field in Redis Hash (`candle:1m:SYMBOL`) is stored as **`YYYYMMDDHHmm` (Integer/String)**, NOT Unix Epoch. This is KST (UTC+9) based.
2.  **Aggregator Service (C++ `aggregator`)**:
    *   Polls Redis for closed candles.
    *   Aggregates 1m candles into higher timeframes (3m, 5m, 1h, etc.).
    *   Saves to **DynamoDB** (`candle_history` table) and S3.
    *   **Protocol**: Persists the same `YYYYMMDDHHmm` format in DynamoDB items.
3.  **Chart API (Node.js Lambda `chart-data-handler`)**:
    *   Reads DynamoDB.
    *   Returns history data to Client.
    *   Payload uses YMDHM numbers for `time` field.
4.  **Client (Web `index.html`)**:
    *   **WebSocket**: Receives Real-time updates directly from Engine (Redis Pub/Sub).
    *   **REST API**: Fetches History from Lambda.
    *   **Rendering**: Uses TradingView Lightweight Charts.

---

## 2. Critical Client-Side Logic (Implemented Fixes)

The client (`index.html`) contains **Compensation Logic** to bridge the gap between "Engine's Custom Format" and "Standard Charting Requirements".

### A. Timestamp Standardization (`ymdhmToEpoch`)
The Engine and DB use KST-based YMDHM integers (e.g., `202512171700`). TradingView requires UTC Unix Epoch Seconds (e.g., `1734422400`).

**Logic:**
1.  **Input Detection**: The function handles generic inputs.
    *   If input is **10-digit number** (e.g., `1734...`): Treat as **Epoch** (return as is).
    *   If input is **12-digit number** (e.g., `2025...`): Treat as **YMDHM**.
2.  **Conversion**:
    *   Parses YMDHM string (KST).
    *   Standardizes to **True UTC Epoch**.
    *   _See `index.html` line ~1790._

### B. Timezone Synchronization (The "9-Hour Gap" Fix)
During development, a discrepancy arose where Real-time updates (from Engine) and Historical Data (from API) were offset by 9 hours due to inconsistent KST/UTC handling in the C++ layer.

**Logic (`updateLiveCandleChart`):**
*   Calculates `Epoch` from incoming message.
*   **Auto-Correction**: If the resulting timestamp is > 8 hours in the future compared to Client System Time (`Date.now()`), it forces a **-9 Hour Adjustment**.
*   This ensures Real-time candles align perfectly with Historical candles on the chart.

### C. Race Condition Handling (Subscription Flow)
A disconnect occurred when subscribing: "Real-time data accumulates -> API loads history -> API overwrites/clears Real-time buffer."

**Logic (`loadChartDataForTimeframe`):**
*   **Buffer Retention**: Does NOT clear the real-time buffer (`oneMinCandleBuffer`) blindly.
*   **Merge Strategy**: After API data loads, the system **re-scans** the real-time buffer. Any data received *during* the API fetch is aggregated and merged ON TOP of the API history.
*   This prevents "missing tips" or "split charts".

### D. Performance Tuning
*   **Render Loop**: Decoupled Data Ingestion (WebSocket) from UI Rendering (RequestAnimationFrame).
*   **Throttling**: Chart updates occur at max 60fps, preventing UI freeze during high-frequency trading.

---

## 3. Pending Technical Debt & Recommendations

### Root Cause of Complexity
The primary source of complexity is the **Engine's decision to store formatted time (`YYYYMMDDHHmm`) in a field named `t`**, which implies a timestamp. This forces every downstream consumer (Aggregator, API, Client) to implement conversion logic.

### Recommendation for Future AI
If refactoring the Engine (`wrapper/src/redis_client.cpp`):
1.  **Change Protocol**: Store `t` as standard **Unix Epoch Milliseconds (UTC)**.
2.  **Derive Display Time**: Let the Client convert Epoch to `YYYY-MM-DD` for display.
3.  **Migration**: This would require a "Stop the World" migration (Clear Redis, migrated DynamoDB/S3 data, update C++ code).

**Current Status**: The Client is stable and robust against this format via the implemented wrappers. **Do not remove `ymdhmToEpoch` or the Timezone Shift logic** unless the Engine is refactored.

---

## 4. File Map (For Context)
*   **Client**: `c:\develop\liquibook\test\web\index.html` (Contains all fixing logic)
*   **Engine Wrapper**: `c:\develop\liquibook\wrapper\src\redis_client.cpp` (Source of YMDHM format)
*   **Aggregator**: `c:\develop\liquibook\aggregator\src\valkey_client.cpp` (Handles aggregation logic)

---
*Generated by Antigravity Component, Deepmind.*
