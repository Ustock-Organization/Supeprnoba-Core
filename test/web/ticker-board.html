<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supernoba Ï†ÑÍ¥ëÌåê + Ìò∏Í∞ÄÏ∞Ω</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --bg-input: #21262d;
            --border: #30363d;
            --text: #c9d1d9;
            --text-muted: #8b949e;
            --accent: #58a6ff;
            --success: #3fb950;
            --danger: #f85149;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--accent), #a371f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .status-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: var(--danger);
        }
        .status-dot.connected { background: var(--success); }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        /* ÏôºÏ™Ω: Ìò∏Í∞ÄÏ∞Ω (Main) */
        .orderbook-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .orderbook-panel h2 {
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-symbol-select {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .main-symbol-select input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
        }

        .main-symbol-select button {
            padding: 8px 16px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .orderbook {
            background: var(--bg-input);
            border-radius: 8px;
            overflow: hidden;
        }

        .ob-header {
            display: grid;
            grid-template-columns: 1fr 80px 80px;
            padding: 8px 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }

        .ob-row {
            display: grid;
            grid-template-columns: 1fr 80px 80px;
            padding: 4px 12px;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .ob-row .price.ask { color: var(--danger); }
        .ob-row .price.bid { color: var(--success); }
        .ob-row .qty { text-align: right; }

        .spread-row {
            text-align: center;
            padding: 12px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .spread-row .price {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .spread-row .change {
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .change.up { color: var(--success); }
        .change.down { color: var(--danger); }

        /* Ïò§Î•∏Ï™Ω: Ï†ÑÍ¥ëÌåê (Sub) */
        .ticker-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
        }

        .ticker-panel h2 {
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .sub-symbol-input {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .sub-symbol-input input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
        }

        .sub-symbol-input button {
            padding: 8px 16px;
            background: var(--success);
            color: #000;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .ticker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .ticker-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            transition: transform 0.2s;
        }

        .ticker-card:hover {
            transform: translateY(-2px);
        }

        .ticker-card .symbol {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .ticker-card .price-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .ticker-card .current-price {
            font-size: 1.4rem;
            font-weight: bold;
        }

        .ticker-card .change-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .ticker-card .change-badge.up {
            background: rgba(63, 185, 80, 0.2);
            color: var(--success);
        }

        .ticker-card .change-badge.down {
            background: rgba(248, 81, 73, 0.2);
            color: var(--danger);
        }

        .ticker-card .prev-change {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .ticker-card .remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
        }

        .ticker-card {
            position: relative;
        }

        .empty-ticker {
            text-align: center;
            color: var(--text-muted);
            padding: 40px;
        }

        /* Ïó∞Í≤∞ ÏÑ§Ï†ï */
        .connect-form {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .connect-form input {
            flex: 1;
            padding: 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.8rem;
        }

        .connect-form button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-connect { background: var(--success); color: #000; }
        .btn-disconnect { background: var(--danger); color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Supernoba Main/Sub Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞</h1>
        </header>

        <!-- Ïó∞Í≤∞ ÏÉÅÌÉú Î∞î -->
        <div class="status-bar">
            <div class="connect-form">
                <input type="text" id="wsEndpoint" value="wss://l2ptm85wub.execute-api.ap-northeast-2.amazonaws.com/production/" placeholder="WebSocket Endpoint">
                <button class="btn-connect" onclick="connect()">Ïó∞Í≤∞</button>
                <button class="btn-disconnect" onclick="disconnect()">Ìï¥Ï†ú</button>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <div id="statusDot" class="status-dot"></div>
                <span id="statusText">Disconnected</span>
            </div>
        </div>

        <div class="main-layout">
            <!-- ÏôºÏ™Ω: Ìò∏Í∞ÄÏ∞Ω (Main Íµ¨ÎèÖ - 1Í∞úÎßå) -->
            <div class="orderbook-panel">
                <h2>üìä Ìò∏Í∞ÄÏ∞Ω (Main)</h2>
                <div class="main-symbol-select">
                    <input type="text" id="mainSymbol" value="TEST" placeholder="Ïã¨Î≥º">
                    <button onclick="subscribeMain()">Íµ¨ÎèÖ</button>
                </div>
                <div id="mainSymbolBadge" style="margin-bottom: 10px; color: var(--accent); font-size: 0.85rem;">
                    Íµ¨ÎèÖ Ï§ë: ÏóÜÏùå
                </div>
                <div class="orderbook">
                    <div class="ob-header">
                        <span>Í∞ÄÍ≤©</span>
                        <span style="text-align: right;">ÏàòÎüâ</span>
                        <span style="text-align: right;">Ï¥ùÏï°</span>
                    </div>
                    <div id="asksList"></div>
                    <div class="spread-row">
                        <span class="price" id="currentPrice">-</span>
                        <span class="change" id="changeRate">-</span>
                    </div>
                    <div id="bidsList"></div>
                </div>
            </div>

            <!-- Ïò§Î•∏Ï™Ω: Ï†ÑÍ¥ëÌåê (Sub Íµ¨ÎèÖ - Î¨¥Ï†úÌïú) -->
            <div class="ticker-panel">
                <h2>üìà Ï†ÑÍ¥ëÌåê (Sub)</h2>
                <div class="sub-symbol-input">
                    <input type="text" id="subSymbols" placeholder="Ïã¨Î≥º (ÏΩ§Îßà Íµ¨Î∂Ñ: AAPL,GOOGL,TSLA)">
                    <button onclick="subscribeSub()">Ï∂îÍ∞Ä</button>
                </div>
                <div id="tickerGrid" class="ticker-grid">
                    <div class="empty-ticker">Ïã¨Î≥ºÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentMainSymbol = null;
        let subSymbols = new Set();
        let tickerData = {};  // {symbol: {p, c, yc}}

        // WebSocket Ïó∞Í≤∞
        function connect() {
            const endpoint = document.getElementById('wsEndpoint').value;
            if (!endpoint) return;

            ws = new WebSocket(endpoint);

            ws.onopen = () => {
                updateStatus(true);
                console.log('WebSocket connected');
            };

            ws.onclose = () => {
                updateStatus(false);
                console.log('WebSocket disconnected');
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleMessage(msg);
                } catch (e) {
                    console.log('Raw:', event.data);
                }
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            currentMainSymbol = null;
            subSymbols.clear();
            tickerData = {};
            updateMainBadge();
            renderTickers();
        }

        function updateStatus(connected) {
            document.getElementById('statusDot').className = connected ? 'status-dot connected' : 'status-dot';
            document.getElementById('statusText').textContent = connected ? 'Connected' : 'Disconnected';
        }

        // Î©îÏãúÏßÄ Ï≤òÎ¶¨
        function handleMessage(msg) {
            if (msg.e === 'd') {
                // Main: Depth Îç∞Ïù¥ÌÑ∞
                renderOrderbook(msg);
            } else if (msg.e === 't') {
                // Sub: Ticker Îç∞Ïù¥ÌÑ∞
                tickerData[msg.s] = {
                    p: msg.p,
                    c: msg.c,
                    yc: msg.yc
                };
                renderTickers();
            }
        }

        // Main Íµ¨ÎèÖ
        function subscribeMain() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Î®ºÏ†Ä Ïó∞Í≤∞ÌïòÏÑ∏Ïöî');
                return;
            }

            const symbol = document.getElementById('mainSymbol').value.toUpperCase();
            if (!symbol) return;

            ws.send(JSON.stringify({
                action: 'subscribe',
                main: symbol
            }));

            currentMainSymbol = symbol;
            updateMainBadge();
        }

        // Sub Íµ¨ÎèÖ Ï∂îÍ∞Ä
        function subscribeSub() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Î®ºÏ†Ä Ïó∞Í≤∞ÌïòÏÑ∏Ïöî');
                return;
            }

            const input = document.getElementById('subSymbols').value.toUpperCase();
            if (!input) return;

            const symbols = input.split(',').map(s => s.trim()).filter(s => s);
            
            ws.send(JSON.stringify({
                action: 'subscribe',
                sub: symbols
            }));

            symbols.forEach(s => {
                subSymbols.add(s);
                tickerData[s] = tickerData[s] || { p: 0, c: 0, yc: 0 };
            });
            
            document.getElementById('subSymbols').value = '';
            renderTickers();
        }

        // Sub Ïã¨Î≥º Ï†úÍ±∞
        function removeSub(symbol) {
            subSymbols.delete(symbol);
            delete tickerData[symbol];
            renderTickers();
            // TODO: ÏÑúÎ≤ÑÏóê unsubscribe ÏöîÏ≤≠
        }

        function updateMainBadge() {
            document.getElementById('mainSymbolBadge').textContent = 
                currentMainSymbol ? `Íµ¨ÎèÖ Ï§ë: ${currentMainSymbol}` : 'Íµ¨ÎèÖ Ï§ë: ÏóÜÏùå';
        }

        // Ìò∏Í∞ÄÏ∞Ω Î†åÎçîÎßÅ
        function renderOrderbook(data) {
            const asksEl = document.getElementById('asksList');
            const bidsEl = document.getElementById('bidsList');
            const priceEl = document.getElementById('currentPrice');
            const changeEl = document.getElementById('changeRate');

            // ÌòÑÏû¨Í∞Ä Î∞è Î≥ÄÎèôÎ•†
            if (data.p) {
                priceEl.textContent = data.p.toLocaleString();
            }
            if (data.c !== undefined) {
                const sign = data.c >= 0 ? '+' : '';
                changeEl.textContent = `${sign}${data.c.toFixed(2)}%`;
                changeEl.className = `change ${data.c >= 0 ? 'up' : 'down'}`;
            }

            // Ask (Îß§ÎèÑ)
            const asks = (data.a || []).slice(0, 10).reverse();
            asksEl.innerHTML = asks.map(a => `
                <div class="ob-row">
                    <span class="price ask">${a[0].toLocaleString()}</span>
                    <span class="qty">${a[1]}</span>
                    <span class="qty">${(a[0] * a[1]).toLocaleString()}</span>
                </div>
            `).join('') || '<div class="ob-row"><span>-</span></div>';

            // Bid (Îß§Ïàò)
            const bids = (data.b || []).slice(0, 10);
            bidsEl.innerHTML = bids.map(b => `
                <div class="ob-row">
                    <span class="price bid">${b[0].toLocaleString()}</span>
                    <span class="qty">${b[1]}</span>
                    <span class="qty">${(b[0] * b[1]).toLocaleString()}</span>
                </div>
            `).join('') || '<div class="ob-row"><span>-</span></div>';
        }

        // Ï†ÑÍ¥ëÌåê Î†åÎçîÎßÅ
        function renderTickers() {
            const grid = document.getElementById('tickerGrid');
            
            if (subSymbols.size === 0) {
                grid.innerHTML = '<div class="empty-ticker">Ïã¨Î≥ºÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</div>';
                return;
            }

            grid.innerHTML = Array.from(subSymbols).map(symbol => {
                const data = tickerData[symbol] || { p: 0, c: 0, yc: 0 };
                const isUp = data.c >= 0;
                const sign = isUp ? '+' : '';
                
                return `
                    <div class="ticker-card">
                        <button class="remove-btn" onclick="removeSub('${symbol}')">√ó</button>
                        <div class="symbol">${symbol}</div>
                        <div class="price-row">
                            <span class="current-price">${data.p ? data.p.toLocaleString() : '-'}</span>
                            <span class="change-badge ${isUp ? 'up' : 'down'}">${sign}${data.c.toFixed(2)}%</span>
                        </div>
                        <div class="prev-change">Ï†ÑÏùº: ${data.yc >= 0 ? '+' : ''}${data.yc.toFixed(2)}%</div>
                    </div>
                `;
            }).join('');
        }

        // Ï¥àÍ∏∞Ìôî
        renderTickers();
    </script>
</body>
</html>
